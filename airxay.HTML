<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI X-Ray Analysis Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC9'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="bg-primary p-3 rounded-full mr-3">
                    <i class="fas fa-x-ray text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">AI X-Ray Analysis Assistant</h1>
            </div>
            <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                Upload an X-ray image to get AI-powered analysis and potential findings. This tool is for educational purposes only.
            </p>
        </div>

        <!-- Medical Disclaimer -->
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                <div>
                    <h3 class="text-red-800 dark:text-red-300 font-semibold mb-2">Medical Disclaimer</h3>
                    <p class="text-red-700 dark:text-red-400 text-sm">
                        This AI analysis is for educational and research purposes only. It is NOT a substitute for professional medical diagnosis, treatment, or advice. Always consult qualified healthcare professionals for medical concerns.
                    </p>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-upload mr-2 text-primary"></i>
                Upload X-Ray Image
            </h2>
            
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary transition-colors duration-300" id="dropZone">
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <div id="uploadContent">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 dark:text-gray-300 mb-2">Drop your X-ray image here or click to browse</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Supports JPG, PNG, WEBP formats</p>
                    <button type="button" class="mt-4 bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg transition-colors duration-300" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
                <div id="imagePreview" class="hidden">
                    <img id="previewImg" class="max-w-full max-h-64 mx-auto rounded-lg shadow-md">
                    <p id="fileName" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></p>
                    <button type="button" class="mt-2 text-primary hover:text-primary-dark text-sm" onclick="removeImage()">
                        <i class="fas fa-times mr-1"></i>Remove
                    </button>
                </div>
            </div>

            <div class="mt-4 flex justify-center">
                <button id="analyzeBtn" class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-lg font-semibold transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="analyzeXray()">
                    <i class="fas fa-brain mr-2"></i>
                    Analyze X-Ray
                </button>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="resultsSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-primary"></i>
                Analysis Results
            </h2>
            
            <div id="loadingState" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300">Analyzing X-ray image... This may take a moment.</p>
            </div>

            <div id="analysisContent" class="hidden">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <h3 class="text-blue-800 dark:text-blue-300 font-semibold mb-2 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        AI Analysis Report
                    </h3>
                    <div id="analysisResult" class="text-blue-700 dark:text-blue-400 prose dark:prose-invert max-w-none"></div>
                </div>

                <div class="grid md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                            <i class="fas fa-search mr-2 text-primary"></i>
                            Key Findings
                        </h4>
                        <div id="keyFindings" class="text-gray-600 dark:text-gray-300 text-sm"></div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                            <i class="fas fa-lightbulb mr-2 text-primary"></i>
                            Recommendations
                        </h4>
                        <div id="recommendations" class="text-gray-600 dark:text-gray-300 text-sm"></div>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <button onclick="resetAnalysis()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors duration-300">
                        <i class="fas fa-redo mr-2"></i>
                        Analyze Another Image
                    </button>
                </div>
            </div>

            <div id="errorState" class="hidden text-center py-8">
                <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                <p class="text-red-600 dark:text-red-400 font-semibold">Analysis Failed</p>
                <p id="errorMessage" class="text-gray-600 dark:text-gray-300 mt-2"></p>
                <button onclick="resetAnalysis()" class="mt-4 bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg transition-colors duration-300">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const uploadContent = document.getElementById('uploadContent');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // Drag and drop functionality
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            selectedFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                fileName.textContent = file.name;
                uploadContent.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                analyzeBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            selectedFile = null;
            uploadContent.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            analyzeBtn.disabled = true;
            fileInput.value = '';
        }

        let isPoeEnvironment = false;

        // Wait for Poe API to be available and register handler
        function initializePoeAPI() {
            if (window.Poe && window.Poe.registerHandler) {
                isPoeEnvironment = true;
                // Register handler for AI response
                window.Poe.registerHandler("xray-analysis", (result, context) => {
                    const loadingState = document.getElementById('loadingState');
                    const analysisContent = document.getElementById('analysisContent');
                    const errorState = document.getElementById('errorState');
                    const analysisResult = document.getElementById('analysisResult');

                    if (result.responses && result.responses.length > 0) {
                        const response = result.responses[0];
                        
                        if (response.status === "error") {
                            loadingState.classList.add('hidden');
                            errorState.classList.remove('hidden');
                            document.getElementById('errorMessage').textContent = response.statusText || "An error occurred during analysis.";
                        } else if (response.status === "incomplete") {
                            // Update with partial content while streaming
                            analysisResult.innerHTML = marked.parse(response.content);
                        } else if (response.status === "complete") {
                            // Final analysis complete
                            loadingState.classList.add('hidden');
                            analysisContent.classList.remove('hidden');
                            
                            // Parse and display the full analysis
                            const fullAnalysis = response.content;
                            analysisResult.innerHTML = marked.parse(fullAnalysis);
                            
                            // Extract key findings and recommendations if possible
                            extractKeyPoints(fullAnalysis);
                        }
                    }
                });
                console.log("Poe API handler registered successfully");
                hideAPIWarning();
            } else {
                // Check if we're in an iframe (likely Poe environment) but API not ready
                if (window !== window.top) {
                    // Retry after a short delay
                    setTimeout(initializePoeAPI, 100);
                } else {
                    // Not in Poe environment, show demo mode
                    showDemoMode();
                }
            }
        }

        function hideAPIWarning() {
            const warningElement = document.getElementById('apiWarning');
            if (warningElement) {
                warningElement.remove();
            }
        }

        function showDemoMode() {
            // Add demo mode notice after medical disclaimer
            const disclaimer = document.querySelector('.bg-red-50');
            const demoNotice = document.createElement('div');
            demoNotice.className = 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6';
            demoNotice.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                    <div>
                        <h3 class="text-blue-800 dark:text-blue-300 font-semibold mb-2">Demo Mode</h3>
                        <p class="text-blue-700 dark:text-blue-400 text-sm mb-2">
                            You're running this outside the Poe Canvas environment. AI analysis is not available, but you can see a demo analysis.
                        </p>
                        <p class="text-blue-700 dark:text-blue-400 text-sm">
                            For full AI-powered analysis, use this app in <a href="https://poe.com" target="_blank" class="underline font-medium">Poe Canvas</a>.
                        </p>
                    </div>
                </div>
            `;
            disclaimer.parentNode.insertBefore(demoNotice, disclaimer.nextSibling);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializePoeAPI);
        // Also try immediately in case DOM is already ready
        initializePoeAPI();

        async function analyzeXray() {
            if (!selectedFile) return;

            // Show results section with loading state
            const resultsSection = document.getElementById('resultsSection');
            const loadingState = document.getElementById('loadingState');
            const analysisContent = document.getElementById('analysisContent');
            const errorState = document.getElementById('errorState');

            resultsSection.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            analysisContent.classList.add('hidden');
            errorState.classList.add('hidden');

            // Check if Poe API is available
            if (!isPoeEnvironment) {
                // Demo mode - show sample analysis
                showDemoAnalysis();
                return;
            }

            try {
                // Send image to AI for analysis
                await window.Poe.sendUserMessage(
                    "@Claude-Sonnet-4 You are an experienced radiologist. Perform a systematic X-ray analysis with precise alignment assessment:\n\n**CLINICAL INFORMATION & TECHNIQUE:**\n- Projection type (AP/PA/Lateral/Oblique)\n- Technical adequacy (penetration, rotation, angulation)\n- Patient positioning assessment\n\n**ALIGNMENT ANALYSIS (Critical):**\n- Anatomical alignment lines and reference points\n- Angular measurements with normal ranges\n- Bilateral symmetry comparison\n- Joint congruency assessment\n- Bone axis relationships\n- Specific alignment parameters (e.g., cervical lordosis 20-40°, lumbar lordosis 40-60°)\n- Subluxation or dislocation assessment\n\n**SKELETAL FINDINGS:**\n- Bone morphology and architecture\n- Cortical continuity and thickness\n- Trabecular pattern analysis\n- Joint space measurements\n- Growth plate assessment (if applicable)\n\n**SOFT TISSUE EVALUATION:**\n- Soft tissue shadows and density\n- Swelling or asymmetry\n- Fat plane displacement\n\n**PATHOLOGICAL ASSESSMENT:**\n- Normal anatomical variants\n- Abnormal findings with severity grading\n- Differential diagnoses ranked by likelihood\n- Confidence levels for each finding\n\n**MEASUREMENTS & ANGLES:**\n- Provide specific angular measurements where applicable\n- Compare to established normal ranges\n- Note any deviation from anatomical norms\n\n**CLINICAL IMPRESSION:**\n- Primary diagnosis with confidence level\n- Secondary findings\n- Clinical significance and urgency\n\n**RECOMMENDATIONS:**\n- Additional imaging if needed\n- Clinical correlation requirements\n- Follow-up timeline\n\nBe extremely specific about alignment assessment as this is critical for diagnosis. Use precise anatomical terminology and provide numerical values where possible.",
                    {
                        attachments: [selectedFile],
                        handler: "xray-analysis",
                        stream: true,
                        openChat: false
                    }
                );
            } catch (error) {
                console.error("Analysis error:", error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message || "Failed to start analysis. Please try again.";
            }
        }

        function showDemoAnalysis() {
            const loadingState = document.getElementById('loadingState');
            const analysisContent = document.getElementById('analysisContent');
            const analysisResult = document.getElementById('analysisResult');
            
            // Simulate loading time
            setTimeout(() => {
                loadingState.classList.add('hidden');
                analysisContent.classList.remove('hidden');
                
                const demoAnalysis = `
# COMPREHENSIVE RADIOLOGICAL ANALYSIS REPORT
**DEMO VERSION - Advanced Alignment Assessment**

---

## CLINICAL INFORMATION & TECHNIQUE

**Examination Type:** Digital Radiography  
**Projection:** AP/PA and/or Lateral views  
**Technical Quality:** Optimal penetration, minimal rotation  
**Patient Positioning:** Anatomically correct alignment demonstrated  
**Radiation Dose:** Optimized according to ALARA principles  

---

## CRITICAL ALIGNMENT ANALYSIS

### Anatomical Reference Lines & Measurements

#### Spinal Alignment (Example - Cervical)
- **Cervical Lordosis:** 20-40° (Normal range)
- **C1-C2 Atlantoaxial Joint:** <3mm ADI (atlantodental interval)
- **Posterior Cervical Line:** Smooth curvature maintained
- **Spinolaminar Line:** Continuous alignment verified
- **Prevertebral Soft Tissue:** <7mm at C2, <22mm at C6

#### Long Bone Alignment Parameters
- **Anatomical Axis:** Straight longitudinal axis preserved
- **Mechanical Axis:** Load-bearing alignment assessed
- **Joint Line Convergence:** Parallel joint surfaces
- **Angular Deformity Assessment:** Valgus/varus angulation measured

### Specific Regional Alignment

#### Hip Joint Alignment
- **Shenton's Line:** Smooth continuous arc
- **Acetabular Angle:** 25-40° (normal range)
- **Center-Edge Angle:** >25° (adequate coverage)
- **Femoral Head Coverage:** Concentrically positioned

#### Knee Alignment
- **Femorotibial Angle:** 5-7° valgus (physiologic)
- **Joint Space Width:** 3-5mm (medial/lateral)
- **Patellar Position:** Central tracking assessed
- **Tibial Plateau Angle:** 7-10° posterior slope

#### Ankle/Foot Alignment
- **Tibiotalar Angle:** 92-96° (mortise alignment)
- **Calcaneal Pitch:** 20-30° (lateral view)
- **Meary's Line:** Straight talar-first metatarsal axis
- **Böhler's Angle:** 25-40° (calcaneal tuberosity)

---

## BILATERAL SYMMETRY ASSESSMENT

### Comparative Measurements
- **Right vs Left Comparison:** Symmetric alignment verified
- **Angular Measurements:** Within 5° bilateral tolerance
- **Joint Space Symmetry:** Comparable measurements
- **Bone Length Assessment:** <1cm discrepancy acceptable

### Rotational Assessment
- **AP View Rotation:** Symmetric pedicle shadows
- **Lateral View Quality:** True lateral positioning
- **Oblique Views:** Optimal facet joint visualization

---

## JOINT CONGRUENCY ANALYSIS

### Articular Surface Assessment
- **Joint Space Preservation:** Uniform 2-4mm width
- **Subchondral Bone:** Intact sclerotic line
- **Articular Margins:** Smooth cortical outline
- **Joint Effusion Signs:** No capsular distension

### Subluxation/Dislocation Evaluation
- **Concentricity Index:** >75% (hip coverage)
- **Translation Measurements:** <2mm displacement
- **Angulation Assessment:** <5° from normal
- **Instability Patterns:** Static vs dynamic evaluation

---

## ANGULAR MEASUREMENTS & DEVIATIONS

### Normal Range References
| Measurement | Normal Range | Demo Value |
|-------------|--------------|-------------|
| Cervical Lordosis | 20-40° | 32° ✓ |
| Lumbar Lordosis | 40-60° | 52° ✓ |
| Thoracic Kyphosis | 20-45° | 38° ✓ |
| Femorotibial Angle | 5-7° valgus | 6° ✓ |
| Acetabular Angle | 25-40° | 33° ✓ |

### Deviation Analysis
- **Scoliosis Assessment:** Cobb angle measurement
- **Coronal Plane Deformity:** Frontal plane alignment
- **Sagittal Plane Balance:** Anterior-posterior positioning
- **Rotational Component:** Vertebral rotation assessment

---

## PATHOLOGICAL ALIGNMENT ASSESSMENT

### Fracture-Related Misalignment
🔍 **Angulation:** Would measure degrees of deformity  
🔍 **Displacement:** Percentage of cortical width  
🔍 **Rotation:** Clinical and radiographic assessment  
🔍 **Shortening:** Actual vs functional length  

### Degenerative Alignment Changes
🔍 **Joint Space Narrowing:** Progressive measurement  
🔍 **Osteophyte Formation:** Marginal bone growth  
🔍 **Subchondral Sclerosis:** Reactive bone changes  
🔍 **Subluxation Patterns:** Chronic instability  

---

## DEVELOPMENTAL ALIGNMENT VARIATIONS

### Pediatric Considerations
- **Growth Plate Alignment:** Physeal orientation
- **Developmental Angles:** Age-appropriate ranges
- **Ossification Centers:** Sequential appearance
- **Growth Disturbances:** Angular deformity patterns

### Adult Variants
- **Anatomical Variations:** Within normal limits
- **Compensatory Changes:** Adjacent segment adaptation
- **Age-Related Changes:** Physiologic degeneration

---

## BIOMECHANICAL ASSESSMENT

### Load Distribution Analysis
- **Weight-Bearing Alignment:** Mechanical axis evaluation
- **Stress Concentration:** High-load region assessment
- **Compensatory Mechanisms:** Adjacent joint adaptation
- **Functional Implications:** Movement pattern analysis

### Stability Evaluation
- **Static Stability:** Bony constraint assessment
- **Dynamic Factors:** Ligamentous contribution
- **Muscular Control:** Functional stability requirements

---

## CLINICAL IMPRESSION

**Primary Assessment:** Comprehensive alignment analysis demonstration  
**Confidence Level:** Educational example (95% for demo purposes)  
**Critical Findings:** No acute alignment abnormalities (demo)  
**Clinical Significance:** Normal variant within acceptable limits  

### Differential Alignment Considerations
1. **Normal Anatomical Variant:** Most likely (demo scenario)
2. **Compensatory Alignment:** Secondary to adjacent pathology
3. **Early Degenerative Changes:** Age-related modifications
4. **Subclinical Instability:** Requires dynamic assessment

---

## ALIGNMENT-SPECIFIC RECOMMENDATIONS

### Immediate Assessment
- **Dynamic Studies:** Stress views if instability suspected
- **Comparative Views:** Previous imaging for progression
- **Functional Evaluation:** Clinical correlation essential
- **Load-Bearing Assessment:** Weight-bearing views indicated

### Monitoring Protocol
- **Serial Alignment:** Track progressive changes
- **Angular Measurement:** Quantitative assessment
- **Functional Impact:** Clinical symptom correlation
- **Treatment Response:** Post-intervention alignment

### Advanced Imaging Considerations
- **CT Reconstruction:** 3D alignment assessment
- **MRI Evaluation:** Soft tissue constraint analysis
- **Dynamic Fluoroscopy:** Real-time motion evaluation
- **Nuclear Medicine:** Metabolic activity assessment

---

## TECHNICAL ALIGNMENT NOTES

**Measurement Accuracy:** ±2° standard deviation  
**Reference Standards:** International orthopedic guidelines  
**Quality Assurance:** Calibrated measurement tools  
**Reproducibility:** Inter-observer reliability >90%  

---

**CRITICAL NOTE:** This demonstration showcases the complexity and precision required in radiological alignment assessment. Actual clinical evaluation demands:
- Precise measurement techniques
- Correlation with clinical presentation
- Understanding of normal variants
- Recognition of pathological deviations

**For Real AI-Powered Alignment Analysis:** Access this application through Poe Canvas for actual image-specific measurements and clinical correlations.

---
*Advanced Alignment Assessment Demo | AI X-Ray Analysis Assistant v2.0*
                `;
                
                analysisResult.innerHTML = marked.parse(demoAnalysis);
                
                // Set demo key findings and recommendations
                document.getElementById('keyFindings').innerHTML = `
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Anatomical Alignment:</strong> Within normal parameters</li>
                        <li><strong>Angular Measurements:</strong> All values within standard ranges</li>
                        <li><strong>Joint Congruency:</strong> Concentrically positioned</li>
                        <li><strong>Bilateral Symmetry:</strong> <5° variance bilateral</li>
                        <li><strong>Reference Lines:</strong> Continuous anatomical landmarks</li>
                        <li><strong>Demo Note:</strong> Real analysis includes precise measurements</li>
                    </ul>
                `;
                document.getElementById('recommendations').innerHTML = `
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Clinical Correlation:</strong> Essential for diagnosis</li>
                        <li><strong>Comparison Studies:</strong> Previous imaging review</li>
                        <li><strong>Follow-up:</strong> Based on clinical presentation</li>
                        <li><strong>Real AI Analysis:</strong> Available in Poe Canvas</li>
                    </ul>
                `;
                
            }, 2000);
        }

        function extractKeyPoints(analysisText) {
            // Simple extraction of key points - this could be enhanced
            const keyFindings = document.getElementById('keyFindings');
            const recommendations = document.getElementById('recommendations');

            // Look for findings section
            const findingsMatch = analysisText.match(/(?:findings?|abnormal|pathology)[:\s]+(.*?)(?:\n\n|\d\)|$)/is);
            if (findingsMatch) {
                keyFindings.innerHTML = marked.parse(findingsMatch[1].substring(0, 200) + '...');
            } else {
                keyFindings.textContent = 'See full analysis above for detailed findings.';
            }

            // Look for recommendations section
            const recMatch = analysisText.match(/(?:recommend|suggestion|follow[-\s]?up)[:\s]+(.*?)(?:\n\n|\d\)|$)/is);
            if (recMatch) {
                recommendations.innerHTML = marked.parse(recMatch[1].substring(0, 200) + '...');
            } else {
                recommendations.textContent = 'See full analysis above for recommendations.';
            }
        }

        function resetAnalysis() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('hidden');
            removeImage();
        }

        function showError(message) {
            // Only show errors in Poe environment, not in demo mode
            if (!isPoeEnvironment) return;
            
            // Create a simple error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    ${message}
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
