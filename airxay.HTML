<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI X-Ray Analysis Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B4BC9'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="bg-primary p-3 rounded-full mr-3">
                    <i class="fas fa-x-ray text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">AI X-Ray Analysis Assistant</h1>
            </div>
            <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                Upload an X-ray image to get AI-powered analysis and potential findings. This tool is for educational purposes only.
            </p>
        </div>



        <!-- Upload Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-upload mr-2 text-primary"></i>
                Upload X-Ray Image
            </h2>
            
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary transition-colors duration-300" id="dropZone">
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <div id="uploadContent">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 dark:text-gray-300 mb-2">Drop your X-ray image here or click to browse</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Supports JPG, PNG, WEBP formats</p>
                    <button type="button" class="mt-4 bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg transition-colors duration-300" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
                <div id="imagePreview" class="hidden">
                    <div class="relative inline-block">
                        <img id="previewImg" class="max-w-full max-h-64 mx-auto rounded-lg shadow-md">
                        <canvas id="annotationCanvas" class="absolute top-0 left-0 pointer-events-none rounded-lg"></canvas>
                    </div>
                    <p id="fileName" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></p>
                    <button type="button" class="mt-2 text-primary hover:text-primary-dark text-sm" onclick="removeImage()">
                        <i class="fas fa-times mr-1"></i>Remove
                    </button>
                    <div id="annotationControls" class="mt-2 flex justify-center space-x-2 hidden">
                        <button onclick="clearAnnotations()" class="text-xs bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            <i class="fas fa-eraser mr-1"></i>Clear Annotations
                        </button>
                        <button onclick="toggleAnnotations()" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                            <i class="fas fa-eye mr-1"></i>Toggle Markers
                        </button>
                        <button onclick="testAnnotations()" class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
                            <i class="fas fa-vial mr-1"></i>Test Markers
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex justify-center">
                <button id="analyzeBtn" class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-lg font-semibold transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="analyzeXray()">
                    <i class="fas fa-brain mr-2"></i>
                    Analyze X-Ray
                </button>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="resultsSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-primary"></i>
                Analysis Results
            </h2>
            
            <div id="loadingState" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300">Analyzing X-ray image... This may take a moment.</p>
            </div>

            <div id="analysisContent" class="hidden">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                    <h3 class="text-blue-800 dark:text-blue-300 font-semibold mb-2 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        AI Analysis Report
                    </h3>
                    <div id="analysisResult" class="text-blue-700 dark:text-blue-400 prose dark:prose-invert max-w-none"></div>
                </div>

                <div class="grid md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                            <i class="fas fa-search mr-2 text-primary"></i>
                            Key Findings
                        </h4>
                        <div id="keyFindings" class="text-gray-600 dark:text-gray-300 text-sm"></div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2 flex items-center">
                            <i class="fas fa-lightbulb mr-2 text-primary"></i>
                            Recommendations
                        </h4>
                        <div id="recommendations" class="text-gray-600 dark:text-gray-300 text-sm"></div>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <button onclick="resetAnalysis()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors duration-300">
                        <i class="fas fa-redo mr-2"></i>
                        Analyze Another Image
                    </button>
                </div>
            </div>

            <div id="errorState" class="hidden text-center py-8">
                <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                <p class="text-red-600 dark:text-red-400 font-semibold">Analysis Failed</p>
                <p id="errorMessage" class="text-gray-600 dark:text-gray-300 mt-2"></p>
                <button onclick="resetAnalysis()" class="mt-4 bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg transition-colors duration-300">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const uploadContent = document.getElementById('uploadContent');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // Drag and drop functionality
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900/20');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            selectedFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                fileName.textContent = file.name;
                uploadContent.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                analyzeBtn.disabled = false;
                
                // Clear any existing annotations
                clearAnnotations();
                
                // Initialize canvas after image loads
                previewImg.onload = function() {
                    setupCanvas();
                };
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            selectedFile = null;
            uploadContent.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            analyzeBtn.disabled = true;
            fileInput.value = '';
        }

        let isPoeEnvironment = false;

        // Wait for Poe API to be available and register handler
        function initializePoeAPI() {
            if (window.Poe && window.Poe.registerHandler) {
                isPoeEnvironment = true;
                // Register handler for AI response
                window.Poe.registerHandler("xray-analysis", (result, context) => {
                    const loadingState = document.getElementById('loadingState');
                    const analysisContent = document.getElementById('analysisContent');
                    const errorState = document.getElementById('errorState');
                    const analysisResult = document.getElementById('analysisResult');

                    if (result.responses && result.responses.length > 0) {
                        const response = result.responses[0];
                        
                        if (response.status === "error") {
                            loadingState.classList.add('hidden');
                            errorState.classList.remove('hidden');
                            document.getElementById('errorMessage').textContent = response.statusText || "An error occurred during analysis.";
                        } else if (response.status === "incomplete") {
                            // Update with partial content while streaming
                            const cleanContent = processAnalysisContent(response.content);
                            analysisResult.innerHTML = marked.parse(cleanContent);
                        } else if (response.status === "complete") {
                            // Final analysis complete
                            loadingState.classList.add('hidden');
                            analysisContent.classList.remove('hidden');
                            
                            // Process the full analysis with annotations
                            const fullAnalysis = response.content;
                            const cleanContent = processAnalysisContent(fullAnalysis);
                            analysisResult.innerHTML = marked.parse(cleanContent);
                            
                            // Extract key findings and recommendations if possible
                            extractKeyPoints(fullAnalysis);
                        }
                    }
                });
                console.log("Poe API handler registered successfully");
                hideAPIWarning();
            } else {
                // Check if we're in an iframe (likely Poe environment) but API not ready
                if (window !== window.top) {
                    // Retry after a short delay
                    setTimeout(initializePoeAPI, 100);
                } else {
                    // Not in Poe environment, show demo mode
                    showDemoMode();
                }
            }
        }

        function hideAPIWarning() {
            const warningElement = document.getElementById('apiWarning');
            if (warningElement) {
                warningElement.remove();
            }
        }

        function showDemoMode() {
            // Check if demo notice already exists
            if (document.querySelector('.demo-mode-notice')) {
                return; // Don't add duplicate notices
            }

            // Add demo mode notice after header
            const header = document.querySelector('.text-center.mb-8');
            const demoNotice = document.createElement('div');
            demoNotice.className = 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6 demo-mode-notice';
            demoNotice.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                    <div>
                        <h3 class="text-blue-800 dark:text-blue-300 font-semibold mb-2">Demo Mode</h3>
                        <p class="text-blue-700 dark:text-blue-400 text-sm mb-2">
                            You're running this outside the Poe Canvas environment. AI analysis is not available, but you can see a demo analysis.
                        </p>
                        <p class="text-blue-700 dark:text-blue-400 text-sm">
                            For full AI-powered analysis, use this app in <a href="https://poe.com" target="_blank" class="underline font-medium">Poe Canvas</a>.
                        </p>
                    </div>
                </div>
            `;
            header.parentNode.insertBefore(demoNotice, header.nextSibling);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializePoeAPI);
        // Also try immediately in case DOM is already ready
        initializePoeAPI();

        async function analyzeXray() {
            if (!selectedFile) return;

            // Show results section with loading state
            const resultsSection = document.getElementById('resultsSection');
            const loadingState = document.getElementById('loadingState');
            const analysisContent = document.getElementById('analysisContent');
            const errorState = document.getElementById('errorState');

            resultsSection.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            analysisContent.classList.add('hidden');
            errorState.classList.add('hidden');

            // Check if Poe API is available
            if (!isPoeEnvironment) {
                // Demo mode - show sample analysis
                showDemoAnalysis();
                return;
            }

            try {
                // Send image to AI for analysis
                await window.Poe.sendUserMessage(
                    "@Claude-Sonnet-4 You are a senior consultant diagnostic radiologist with 20+ years experience analyzing X-rays in major medical centers. Perform SYSTEMATIC DIAGNOSTIC SCANNING with the same precision as advanced medical imaging software.\n\n**üî¨ SYSTEMATIC DIAGNOSTIC SCANNING PROTOCOL**\n\nPerform comprehensive systematic analysis following hospital-grade diagnostic protocols:\n\n## **üìã FRACTURE ANALYSIS PROTOCOL**\nüîç **Acute Fractures:** Scan for cortical discontinuity, fracture lines, bone fragments\nüîç **Stress Fractures:** Identify sclerotic lines, callus formation, cortical thickening\nüîç **Pathological Fractures:** Assess underlying bone weakness, tumor involvement\nüîç **Healing Assessment:** Evaluate callus formation, union progress, complications\nüîç **Classification:** Apply AO/OTA classification system with exact codes\nüîç **Measurements:** Precise displacement (mm), angulation (degrees), gap width\nüîç **Stability Assessment:** Stable vs unstable patterns, surgical indicators\n\n## **ü¶† INFECTION DETECTION MATRIX**\nüîç **Osteomyelitis:** Scan for bone destruction, sequestra, involucrum formation\nüîç **Septic Arthritis:** Identify joint space widening, erosions, effusion\nüîç **Soft Tissue Abscess:** Detect gas patterns, fluid collections, mass effect\nüîç **Chronic Changes:** Assess sclerosis, deformity patterns, chronic osteomyelitis\nüîç **Staging:** Acute (<2 weeks), subacute (2-6 weeks), chronic (>6 weeks)\nüîç **Distribution:** Focal vs multifocal, cortical vs medullary involvement\n\n## **üéØ TUMOR SCREENING PROTOCOL**\nüîç **Primary Bone Tumors:** Scan for aggressive vs benign lesion patterns\nüîç **Metastatic Disease:** Identify blastic, lytic, or mixed deposits\nüîç **Soft Tissue Masses:** Detect abnormal density, calcifications, invasion\nüîç **Cortical Expansion:** Assess endosteal scalloping, cortical breakthrough\nüîç **Matrix Analysis:** Identify osteoid, chondroid, or fibrous matrix\nüîç **Growth Pattern:** Geographic, moth-eaten, or permeative destruction\nüîç **Periosteal Reaction:** Solid, laminated, spiculated, or Codman triangle\n\n## **ü¶¥ JOINT DISEASE ANALYSIS**\nüîç **Osteoarthritis:** Kellgren-Lawrence grading (0-4), joint space narrowing\nüîç **Rheumatoid Arthritis:** Marginal erosions, symmetric involvement\nüîç **Psoriatic Arthritis:** Pencil-in-cup deformities, DIP involvement\nüîç **Ankylosing Spondylitis:** Bamboo spine, sacroiliac changes\nüîç **Crystal Arthropathy:** Chondrocalcinosis, tophi, punched-out lesions\nüîç **Septic Arthritis:** Joint destruction, rapid progression\n\n## **üíÄ BONE DENSITY ASSESSMENT**\nüîç **Osteoporosis:** Cortical thinning, trabecular pattern, compression fractures\nüîç **Osteomalacia:** Looser zones, coarsened trabeculae, deformities\nüîç **Hyperparathyroidism:** Brown tumors, salt-pepper skull, subperiosteal resorption\nüîç **Paget's Disease:** Cotton wool appearance, blade of grass sign\nüîç **Sclerotic Conditions:** Osteopetrosis, mastocytosis, fluorosis\n\n## **üö® TRAUMA EVALUATION**\nüîç **High-Energy Trauma:** Complex fractures, soft tissue injury, instability\nüîç **Low-Energy Trauma:** Simple fractures, minimal displacement\nüîç **Pediatric Patterns:** Growth plate injuries, plastic deformation, buckle fractures\nüîç **Pathological Fractures:** Underlying tumor, infection, metabolic disease\nüîç **Complications:** Non-union, malunion, avascular necrosis, infection\n\n---\n\n## **üéØ MANDATORY SYSTEMATIC SCANNING FORMAT:**\n\n**TECHNIQUE ASSESSMENT:**\n- Image quality, positioning, exposure parameters\n- Anatomical coverage, rotation artifacts\n- Comparison with previous studies\n\n**SYSTEMATIC REGION-BY-REGION ANALYSIS:**\n\n### **BONE CORTEX SCANNING:**\n- Cortical continuity assessment\n- Thickness measurements\n- Surface irregularities\n- Periosteal reactions\n\n### **TRABECULAR PATTERN ANALYSIS:**\n- Density assessment\n- Architectural distortion\n- Coarsening or thinning\n- Focal abnormalities\n\n### **JOINT SPACE EVALUATION:**\n- Width measurements (normal ranges)\n- Symmetry assessment\n- Erosion identification\n- Effusion detection\n\n### **SOFT TISSUE SCANNING:**\n- Muscle bulk and atrophy\n- Fat plane preservation\n- Mass lesions\n- Gas patterns\n- Calcifications\n\n### **ALIGNMENT ASSESSMENT:**\n- Angular measurements\n- Displacement quantification\n- Rotational deformities\n- Length discrepancies\n\n---\n\n## **üìä DIAGNOSTIC CONFIDENCE SCALING:**\n\n**DEFINITIVE DIAGNOSIS (95-100%):** \n- Clear pathognomonic findings\n- Multiple confirmatory signs\n- Correlates with clinical presentation\n\n**HIGH CONFIDENCE (85-94%):**\n- Characteristic but not pathognomonic\n- Strong supporting evidence\n- Minimal differential considerations\n\n**PROBABLE DIAGNOSIS (70-84%):**\n- Suggestive findings present\n- Limited differential diagnosis\n- Clinical correlation recommended\n\n**POSSIBLE DIAGNOSIS (50-69%):**\n- Equivocal findings\n- Broad differential diagnosis\n- Additional studies recommended\n\n---\n\n## **üéØ ANNOTATION REQUIREMENTS:**\n\nFor EVERY abnormal finding, provide precise annotations:\n[ANNOTATION: anatomical_location | x.x,y.y | specific_diagnosis_with_measurements | confidence_level]\n\nExamples:\n[ANNOTATION: left_femoral_neck | 34.2,67.8 | displaced_femoral_neck_fracture_garden_type_3_15mm_displacement | definitive_95%]\n[ANNOTATION: right_knee_medial_compartment | 67.4,45.2 | severe_osteoarthritis_kellgren_lawrence_grade_4_complete_joint_space_loss | high_confidence_90%]\n[ANNOTATION: lumbar_spine_l3_vertebra | 45.8,32.1 | compression_fracture_25%_height_loss_acute | probable_80%]\n\n---\n\n## **üè• HOSPITAL-GRADE REPORTING FORMAT:**\n\n**PRIMARY DIAGNOSIS:** [Exact condition with ICD-10] - Confidence: [%]\n**SECONDARY DIAGNOSES:** [All additional pathology]\n**MEASUREMENTS:** [Precise quantitative data]\n**CLASSIFICATION:** [Standard medical classifications]\n**URGENCY:** [STAT/Urgent/Routine with timeframe]\n**CLINICAL CORRELATION:** [Expected symptoms and examination findings]\n**TREATMENT RECOMMENDATIONS:** [Specific medical interventions]\n**FOLLOW-UP PROTOCOL:** [Imaging schedule and specialist referrals]\n**PROGNOSIS:** [Expected outcomes and complications]\n\n---\n\n## **‚ö° CRITICAL DIAGNOSTIC CRITERIA:**\n\n1. **SCAN EVERY ANATOMICAL REGION** systematically\n2. **MEASURE ALL ABNORMALITIES** with precise quantification\n3. **CLASSIFY USING STANDARD SCALES** (Kellgren-Lawrence, AO/OTA, etc.)\n4. **ASSESS CLINICAL SIGNIFICANCE** of each finding\n5. **CORRELATE WITH EXPECTED SYMPTOMS** and physical findings\n6. **PROVIDE SPECIFIC TREATMENT GUIDANCE** based on findings\n7. **ASSIGN PRECISE CONFIDENCE LEVELS** to each diagnosis\n8. **ANNOTATE ALL PATHOLOGY** with exact coordinates\n\nYour mission: Perform systematic diagnostic scanning with the precision of advanced medical imaging software, providing hospital-grade diagnostic accuracy that would be used for actual patient care decisions.",
                    {
                        attachments: [selectedFile],
                        handler: "xray-analysis",
                        stream: true,
                        openChat: false
                    }
                );
            } catch (error) {
                console.error("Analysis error:", error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message || "Failed to start analysis. Please try again.";
            }
        }

        function showDemoAnalysis() {
            const loadingState = document.getElementById('loadingState');
            const analysisContent = document.getElementById('analysisContent');
            const analysisResult = document.getElementById('analysisResult');
            
            // Simulate loading time
            setTimeout(() => {
                loadingState.classList.add('hidden');
                analysisContent.classList.remove('hidden');
                
                const demoAnalysis = `
# COMPREHENSIVE DIAGNOSTIC RADIOLOGICAL REPORT
**DEMO VERSION - Advanced Disease Detection & Diagnosis**

---

## CLINICAL INFORMATION & TECHNIQUE

**Examination Type:** Digital Radiography with Disease Analysis Protocol  
**Projection:** Multi-view assessment (AP/PA/Lateral/Oblique)  
**Technical Quality:** Optimal for pathological assessment  
**Patient Demographics:** Age-appropriate analysis standards  
**Clinical Context:** Systematic disease screening performed  

---

## SYSTEMATIC DISEASE DETECTION ANALYSIS

### Pattern Recognition Assessment

#### Bone Lesion Characterization
- **Lytic Lesions:** No geographic, moth-eaten, or permeative patterns identified
- **Sclerotic Lesions:** No areas of increased bone density noted
- **Mixed Lesions:** No combination patterns observed
- **Periosteal Reaction:** Smooth cortical surfaces without elevation
- **Matrix Mineralization:** No abnormal calcification patterns

#### Joint Pathology Screening
- **Inflammatory Arthritis:** No erosions, no joint space narrowing
- **Degenerative Changes:** Minimal age-appropriate wear patterns
- **Crystalline Arthropathy:** No chondrocalcinosis or urate deposits
- **Septic Changes:** No bone destruction or soft tissue gas

### Advanced Pathological Assessment

#### Fracture Analysis Protocol
üîç **Acute Fractures:** No cortical discontinuity identified  
üîç **Stress Fractures:** No sclerotic lines or callus formation  
üîç **Pathological Fractures:** No underlying bone weakness  
üîç **Healing Assessment:** N/A - no fractures present  

#### Infection Detection Matrix
üîç **Osteomyelitis:** No bone destruction, sequestra, or involucrum  
üîç **Septic Arthritis:** No joint space widening or erosions  
üîç **Soft Tissue Abscess:** No gas patterns or fluid collections  
üîç **Chronic Changes:** No sclerosis or deformity patterns  

#### Tumor Screening Protocol
üîç **Primary Bone Tumors:** No aggressive or benign lesion patterns  
üîç **Metastatic Disease:** No blastic or lytic deposits  
üîç **Soft Tissue Masses:** No abnormal density or calcifications  
üîç **Cortical Expansion:** No endosteal scalloping or breakthrough  

---

## SPECIFIC DISEASE CATEGORIES

### Arthritis Classification System

#### Osteoarthritis Assessment (Kellgren-Lawrence Scale)
- **Grade 0:** No radiographic features (Demo Status: ‚úì)
- **Joint Space:** Preserved uniform width 3-4mm
- **Osteophytes:** None identified
- **Subchondral Bone:** Normal density and smooth contour
- **Cysts:** No subchondral cyst formation

#### Inflammatory Arthritis Markers
- **Rheumatoid Pattern:** No marginal erosions or swan-neck deformities
- **Psoriatic Features:** No pencil-in-cup deformities or DIP involvement
- **Ankylosing Spondylitis:** No bamboo spine or sacroiliac changes
- **Crystal Arthropathy:** No chondrocalcinosis or tophi

### Metabolic Bone Disease Assessment

#### Osteoporosis Evaluation
- **Cortical Thickness:** Normal 3-5mm (adequate for age)
- **Trabecular Pattern:** Normal honeycomb architecture
- **Compression Fractures:** None identified
- **Bone Density Markers:** Appears adequate (qualitative assessment)

#### Other Metabolic Conditions
- **Osteomalacia:** No Looser zones or coarsened trabeculae
- **Hyperparathyroidism:** No brown tumors or salt-pepper skull
- **Paget's Disease:** No cotton wool appearance or blade of grass sign

---

## DIFFERENTIAL DIAGNOSIS MATRIX

### Primary Diagnostic Considerations

| Diagnosis | Probability | Confidence | Key Features |
|-----------|-------------|------------|--------------|
| **Normal Variant** | 85% | High | All parameters within normal limits |
| **Age-Related Changes** | 10% | Medium | Minimal wear patterns consistent with age |
| **Early Degenerative Disease** | 3% | Low | Subclinical changes possible |
| **Developmental Anomaly** | 2% | Low | Anatomical variants within normal range |

### Excluded Pathologies (High Confidence)
‚ùå **Malignancy:** No aggressive bone destruction patterns  
‚ùå **Infection:** No inflammatory or destructive changes  
‚ùå **Trauma:** No acute or chronic fracture patterns  
‚ùå **Metabolic Disease:** No characteristic bone changes  

---

## RADIOLOGICAL SIGNS & PATTERN ANALYSIS

### Classic Sign Assessment
- **Shenton's Line:** Intact and smooth (hip integrity)
- **Blumensaat's Line:** Normal positioning (knee stability)
- **Klein's Line:** Appropriate relationship (hip development)
- **Perkins Line:** Normal acetabular coverage
- **Hilgenreiner's Line:** Symmetric hip development

### Pathognomonic Feature Screen
- **Codman Triangle:** Not present (no aggressive lesions)
- **Sunburst Pattern:** Not identified (no osteosarcoma features)
- **Onion Skin:** Not observed (no Ewing sarcoma pattern)
- **Ground Glass:** Not detected (no fibrous dysplasia)

---

## DISEASE STAGING & SEVERITY GRADING

### Functional Assessment
- **Mobility Impact:** No functional limitations predicted
- **Structural Integrity:** Excellent bone architecture
- **Load-Bearing Capacity:** Normal weight-bearing ability
- **Growth Potential:** Normal developmental patterns (if applicable)

### Prognosis Assessment
- **Short-term:** Excellent prognosis with normal function
- **Long-term:** Age-appropriate changes expected
- **Risk Stratification:** Low risk for pathological progression
- **Monitoring Requirements:** Routine surveillance adequate

---

## CLINICAL CORRELATION MATRIX

### Symptom Correlation Analysis
- **Pain Patterns:** Would not explain significant pain symptoms
- **Functional Limitations:** Findings don't correlate with major disability
- **Neurological Symptoms:** No compression or instability patterns
- **Systemic Features:** No radiographic signs of systemic disease

### Laboratory Correlation
- **Inflammatory Markers:** Normal radiographic appearance suggests normal ESR/CRP
- **Bone Turnover Markers:** Likely normal alkaline phosphatase and osteocalcin
- **Infection Markers:** No radiographic evidence of infection
- **Tumor Markers:** No suspicious lesions requiring marker assessment

---

## URGENT vs NON-URGENT CLASSIFICATION

### Emergency Assessment (RED FLAGS) ‚ùå
- **Spinal Cord Compression:** Not identified
- **Pathological Fracture Risk:** Low risk assessment
- **Malignancy Suspicion:** No concerning features
- **Septic Process:** No inflammatory changes

### Routine Follow-up Indications ‚úÖ
- **Age-Appropriate Monitoring:** Standard surveillance intervals
- **Preventive Care:** Bone health maintenance
- **Symptom Correlation:** Clinical follow-up as needed
- **Lifestyle Counseling:** Standard recommendations

---

## ADVANCED DIAGNOSTIC RECOMMENDATIONS

### Additional Imaging Protocols
- **MRI Indication:** Not required based on current findings
- **CT Reconstruction:** Not indicated for current assessment
- **Nuclear Medicine:** No metabolic activity concerns
- **Ultrasound:** Soft tissue evaluation if clinically indicated

### Specialist Referral Guidelines
- **Orthopedic Consultation:** Not urgently required
- **Rheumatology Referral:** Not indicated by current findings
- **Oncology Assessment:** No suspicious lesions identified
- **Endocrine Evaluation:** No metabolic bone disease features

---

## DIAGNOSTIC IMPRESSION

**PRIMARY DIAGNOSIS:** Normal radiographic appearance (Confidence: 90%)  
**SECONDARY FINDINGS:** Age-appropriate variants within normal limits  
**DISEASE STAGE:** N/A - No pathological process identified  
**SEVERITY GRADE:** Normal anatomical structure  
**URGENCY LEVEL:** Routine/Non-urgent  

### Clinical Significance Assessment
- **Immediate Management:** No acute intervention required
- **Long-term Planning:** Standard preventive care appropriate
- **Patient Counseling:** Reassuring normal findings
- **Risk Modification:** General bone health maintenance

---

## TREATMENT IMPLICATIONS & MONITORING

### Immediate Actions Required
- **Emergency Treatment:** None indicated
- **Symptom Management:** Address symptoms clinically (not radiographically based)
- **Activity Restrictions:** No radiographic contraindications
- **Patient Education:** Normal findings, age-appropriate changes

### Follow-up Protocol
- **Imaging Interval:** Based on clinical symptoms and age
- **Monitoring Parameters:** Functional assessment and symptom tracking
- **Disease Progression:** No progressive pathology anticipated
- **Quality of Life:** Excellent prognosis for maintained function

---

## TECHNICAL DIAGNOSTIC NOTES

**Pattern Recognition Accuracy:** 95% confidence in normal assessment  
**Disease Detection Protocol:** Comprehensive systematic analysis completed  
**False Negative Risk:** <5% based on technical quality and systematic review  
**Incidental Finding Screen:** No significant incidental pathology  

---

**CRITICAL DIAGNOSTIC NOTE:** This demonstration showcases comprehensive disease detection and diagnostic radiological analysis. Real clinical practice requires:

- Integration of clinical history and examination
- Correlation with laboratory findings
- Understanding of disease prevalence and risk factors
- Recognition of subtle early pathological changes
- Appropriate use of advanced imaging modalities

**For Actual AI-Powered Disease Detection:** Access this application through Poe Canvas for real-time pathological analysis with actual image-specific disease recognition and diagnostic capabilities.

---

*Advanced Disease Detection & Diagnostic Analysis Demo | AI X-Ray Analysis Assistant v3.0*
                `;
                
                analysisResult.innerHTML = marked.parse(demoAnalysis);
                
                // Add demo annotations to show the feature
                addDemoAnnotations();
                
                // Set demo key findings and recommendations
                document.getElementById('keyFindings').innerHTML = `
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Disease Status:</strong> No pathological processes identified</li>
                        <li><strong>Fracture Screen:</strong> No cortical discontinuity detected</li>
                        <li><strong>Tumor Assessment:</strong> No suspicious lesions or masses</li>
                        <li><strong>Infection Screen:</strong> No signs of osteomyelitis or septic changes</li>
                        <li><strong>Arthritis Evaluation:</strong> No erosions or joint space narrowing</li>
                        <li><strong>Confidence Level:</strong> 90% normal variant assessment</li>
                    </ul>
                `;
                document.getElementById('recommendations').innerHTML = `
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Clinical Correlation:</strong> Essential for diagnosis</li>
                        <li><strong>Comparison Studies:</strong> Previous imaging review</li>
                        <li><strong>Follow-up:</strong> Based on clinical presentation</li>
                        <li><strong>Real AI Analysis:</strong> Available in Poe Canvas</li>
                    </ul>
                `;
                
            }, 2000);
        }

        function extractKeyPoints(analysisText) {
            // Simple extraction of key points - this could be enhanced
            const keyFindings = document.getElementById('keyFindings');
            const recommendations = document.getElementById('recommendations');

            // Look for findings section
            const findingsMatch = analysisText.match(/(?:findings?|abnormal|pathology)[:\s]+(.*?)(?:\n\n|\d\)|$)/is);
            if (findingsMatch) {
                keyFindings.innerHTML = marked.parse(findingsMatch[1].substring(0, 200) + '...');
            } else {
                keyFindings.textContent = 'See full analysis above for detailed findings.';
            }

            // Look for recommendations section
            const recMatch = analysisText.match(/(?:recommend|suggestion|follow[-\s]?up)[:\s]+(.*?)(?:\n\n|\d\)|$)/is);
            if (recMatch) {
                recommendations.innerHTML = marked.parse(recMatch[1].substring(0, 200) + '...');
            } else {
                recommendations.textContent = 'See full analysis above for recommendations.';
            }
        }

        function resetAnalysis() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('hidden');
            removeImage();
        }

        // Annotation system variables
        let annotations = [];
        let annotationsVisible = true;
        let canvas, ctx;

        // Setup canvas for annotations with pixel-perfect precision
        function setupCanvas() {
            canvas = document.getElementById('annotationCanvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            ctx = canvas.getContext('2d');
            const img = document.getElementById('previewImg');
            
            if (img && img.complete && img.naturalWidth > 0) {
                // Get the actual displayed image dimensions with precision
                const imgRect = img.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(img);
                
                // Calculate exact displayed dimensions accounting for object-fit
                const displayWidth = parseFloat(computedStyle.width);
                const displayHeight = parseFloat(computedStyle.height);
                
                // Set high-resolution canvas for pixel-perfect accuracy
                const devicePixelRatio = window.devicePixelRatio || 1;
                canvas.width = displayWidth * devicePixelRatio;
                canvas.height = displayHeight * devicePixelRatio;
                
                // Scale the canvas back down using CSS for crisp rendering
                canvas.style.width = displayWidth + 'px';
                canvas.style.height = displayHeight + 'px';
                
                // Scale the drawing context to match device pixel ratio
                ctx.scale(devicePixelRatio, devicePixelRatio);
                
                // Store precise dimensions for coordinate calculations
                canvas.displayWidth = displayWidth;
                canvas.displayHeight = displayHeight;
                canvas.imageNaturalWidth = img.naturalWidth;
                canvas.imageNaturalHeight = img.naturalHeight;
                
                // Calculate the actual image scaling within the display area
                const scaleX = displayWidth / img.naturalWidth;
                const scaleY = displayHeight / img.naturalHeight;
                const scale = Math.min(scaleX, scaleY);
                
                // Calculate actual image position within the display area (for object-fit: contain)
                const actualImageWidth = img.naturalWidth * scale;
                const actualImageHeight = img.naturalHeight * scale;
                const offsetX = (displayWidth - actualImageWidth) / 2;
                const offsetY = (displayHeight - actualImageHeight) / 2;
                
                canvas.imageScale = scale;
                canvas.imageOffsetX = offsetX;
                canvas.imageOffsetY = offsetY;
                canvas.actualImageWidth = actualImageWidth;
                canvas.actualImageHeight = actualImageHeight;
                
                console.log('High-precision canvas setup:', {
                    canvasSize: `${canvas.width}x${canvas.height}`,
                    displaySize: `${displayWidth}x${displayHeight}`,
                    imageNatural: `${img.naturalWidth}x${img.naturalHeight}`,
                    imageActual: `${actualImageWidth}x${actualImageHeight}`,
                    scale: scale,
                    offset: `${offsetX}, ${offsetY}`,
                    devicePixelRatio: devicePixelRatio
                });
                
                drawAnnotations();
            } else {
                console.log('Image not ready, waiting...');
                setTimeout(setupCanvas, 100);
            }
        }

        // Initialize canvas for annotations (legacy function name kept for compatibility)
        function initializeCanvas() {
            setupCanvas();
        }

        // Parse annotations from AI response with high precision
        function parseAnnotations(analysisText) {
            // Enhanced regex to capture precise decimal coordinates
            const annotationRegex = /\[ANNOTATION:\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([^\]]+)\]/gi;
            const newAnnotations = [];
            let match;

            while ((match = annotationRegex.exec(analysisText)) !== null) {
                const [, region, coordinates, description, severity] = match;
                
                // Enhanced coordinate parsing for high precision
                const coordMatch = coordinates.trim().match(/([0-9]*\.?[0-9]+)\s*,\s*([0-9]*\.?[0-9]+)/);
                if (coordMatch) {
                    const x = parseFloat(coordMatch[1]);
                    const y = parseFloat(coordMatch[2]);
                    
                    // Validate coordinate ranges (0-100%)
                    if (!isNaN(x) && !isNaN(y) && x >= 0 && x <= 100 && y >= 0 && y <= 100) {
                        newAnnotations.push({
                            region: region.trim(),
                            x: x,
                            y: y,
                            description: description.trim(),
                            severity: severity.trim(),
                            rawCoordinates: coordinates.trim()
                        });
                        
                        console.log(`Parsed annotation: ${region.trim()} at (${x.toFixed(2)}%, ${y.toFixed(2)}%) - ${description.trim()}`);
                    } else {
                        console.warn(`Invalid coordinates in annotation: ${coordinates.trim()}`);
                    }
                } else {
                    console.warn(`Could not parse coordinates: "${coordinates.trim()}"`);
                }
            }

            annotations = newAnnotations;
            if (annotations.length > 0) {
                console.log(`Successfully parsed ${annotations.length} high-precision annotations`);
                document.getElementById('annotationControls').classList.remove('hidden');
                initializeCanvas();
            } else {
                console.log('No valid annotations found in the analysis text');
            }
        }

        // Draw medical imaging software-grade annotations with ultimate precision
        function drawAnnotations() {
            if (!canvas || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.displayWidth, canvas.displayHeight);
            
            if (!annotationsVisible || annotations.length === 0) return;

            annotations.forEach((annotation, index) => {
                // Calculate ultra-precise coordinates within the actual image area
                const imageX = (annotation.x / 100) * canvas.actualImageWidth;
                const imageY = (annotation.y / 100) * canvas.actualImageHeight;
                
                // Translate to display coordinates accounting for image centering
                const displayX = canvas.imageOffsetX + imageX;
                const displayY = canvas.imageOffsetY + imageY;
                
                // Validate coordinates are within image bounds
                if (displayX < canvas.imageOffsetX || displayX > canvas.imageOffsetX + canvas.actualImageWidth ||
                    displayY < canvas.imageOffsetY || displayY > canvas.imageOffsetY + canvas.actualImageHeight) {
                    console.warn(`Annotation ${index} coordinates outside image bounds: ${annotation.x}%, ${annotation.y}%`);
                    return;
                }
                
                // Professional medical imaging colors with exact medical standards
                let arrowColor, labelBgColor, severityBadgeColor;
                const severity = annotation.severity.toLowerCase();
                const description = annotation.description.toLowerCase();
                
                if (description.includes('fracture') || description.includes('break') || severity === 'severe') {
                    arrowColor = '#e53e3e'; // Medical emergency red
                    labelBgColor = 'rgba(229, 62, 62, 0.95)';
                    severityBadgeColor = '#c53030';
                } else if (description.includes('infection') || description.includes('pneumonia') || description.includes('narrowing') || severity === 'moderate') {
                    arrowColor = '#ff8c00'; // Medical warning orange
                    labelBgColor = 'rgba(255, 140, 0, 0.95)';
                    severityBadgeColor = '#e07400';
                } else if (description.includes('tumor') || description.includes('mass') || description.includes('lesion')) {
                    arrowColor = '#8b0000'; // Dark medical red for masses
                    labelBgColor = 'rgba(139, 0, 0, 0.95)';
                    severityBadgeColor = '#660000';
                } else if (description.includes('normal') || description.includes('landmark')) {
                    arrowColor = '#00bcd4'; // Medical cyan for normal
                    labelBgColor = 'rgba(0, 188, 212, 0.95)';
                    severityBadgeColor = '#0097a7';
                } else if (severity === 'mild' || description.includes('swelling')) {
                    arrowColor = '#ffa726'; // Medical yellow-orange for mild
                    labelBgColor = 'rgba(255, 167, 38, 0.95)';
                    severityBadgeColor = '#f57c00';
                } else {
                    arrowColor = '#2196f3'; // Medical blue default
                    labelBgColor = 'rgba(33, 150, 243, 0.95)';
                    severityBadgeColor = '#1976d2';
                }

                // Professional medical crosshair target marker
                const crosshairSize = 8;
                const crosshairThickness = 2;
                
                // Draw crosshair with medical precision
                ctx.strokeStyle = arrowColor;
                ctx.lineWidth = crosshairThickness;
                ctx.lineCap = 'round';
                
                // Horizontal crosshair line
                ctx.beginPath();
                ctx.moveTo(displayX - crosshairSize, displayY);
                ctx.lineTo(displayX + crosshairSize, displayY);
                ctx.stroke();
                
                // Vertical crosshair line
                ctx.beginPath();
                ctx.moveTo(displayX, displayY - crosshairSize);
                ctx.lineTo(displayX, displayY + crosshairSize);
                ctx.stroke();
                
                // Central target circle
                ctx.fillStyle = arrowColor;
                ctx.beginPath();
                ctx.arc(displayX, displayY, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                // White outline for contrast on any background
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(displayX, displayY, 3, 0, 2 * Math.PI);
                ctx.stroke();
                
                // Professional medical arrow with optimized positioning
                const arrowLength = 80;
                const arrowThickness = 4;
                const headLength = 20;
                
                // Smart arrow positioning based on image quadrant
                let arrowStartX, arrowStartY, arrowEndX, arrowEndY;
                const centerX = canvas.imageOffsetX + canvas.actualImageWidth / 2;
                const centerY = canvas.imageOffsetY + canvas.actualImageHeight / 2;
                
                // Determine optimal arrow direction based on target position
                if (displayX < centerX && displayY < centerY) {
                    // Top-left quadrant - arrow from top-left
                    arrowStartX = displayX - arrowLength * 0.8;
                    arrowStartY = displayY - arrowLength * 0.6;
                } else if (displayX >= centerX && displayY < centerY) {
                    // Top-right quadrant - arrow from top-right
                    arrowStartX = displayX + arrowLength * 0.8;
                    arrowStartY = displayY - arrowLength * 0.6;
                } else if (displayX < centerX && displayY >= centerY) {
                    // Bottom-left quadrant - arrow from bottom-left
                    arrowStartX = displayX - arrowLength * 0.8;
                    arrowStartY = displayY + arrowLength * 0.6;
                } else {
                    // Bottom-right quadrant - arrow from bottom-right
                    arrowStartX = displayX + arrowLength * 0.8;
                    arrowStartY = displayY + arrowLength * 0.6;
                }
                
                // Ensure arrow starts within canvas bounds
                arrowStartX = Math.max(20, Math.min(canvas.displayWidth - 20, arrowStartX));
                arrowStartY = Math.max(20, Math.min(canvas.displayHeight - 20, arrowStartY));
                
                // Calculate precise end point near the target
                const angle = Math.atan2(displayY - arrowStartY, displayX - arrowStartX);
                arrowEndX = displayX - Math.cos(angle) * (crosshairSize + 5);
                arrowEndY = displayY - Math.sin(angle) * (crosshairSize + 5);
                
                // Draw arrow shaft with medical grade styling
                ctx.strokeStyle = arrowColor;
                ctx.lineWidth = arrowThickness;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Arrow shadow for depth
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = arrowThickness + 2;
                ctx.beginPath();
                ctx.moveTo(arrowStartX + 2, arrowStartY + 2);
                ctx.lineTo(arrowEndX + 2, arrowEndY + 2);
                ctx.stroke();
                
                // Main arrow shaft
                ctx.strokeStyle = arrowColor;
                ctx.lineWidth = arrowThickness;
                ctx.beginPath();
                ctx.moveTo(arrowStartX, arrowStartY);
                ctx.lineTo(arrowEndX, arrowEndY);
                ctx.stroke();

                // Professional arrowhead
                const headAngle = Math.atan2(arrowEndY - arrowStartY, arrowEndX - arrowStartX);
                const headPoint1X = arrowEndX - headLength * Math.cos(headAngle - Math.PI / 6);
                const headPoint1Y = arrowEndY - headLength * Math.sin(headAngle - Math.PI / 6);
                const headPoint2X = arrowEndX - headLength * Math.cos(headAngle + Math.PI / 6);
                const headPoint2Y = arrowEndY - headLength * Math.sin(headAngle + Math.PI / 6);
                
                // Arrowhead shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.moveTo(arrowEndX + 2, arrowEndY + 2);
                ctx.lineTo(headPoint1X + 2, headPoint1Y + 2);
                ctx.lineTo(headPoint2X + 2, headPoint2Y + 2);
                ctx.closePath();
                ctx.fill();
                
                // Main arrowhead
                ctx.fillStyle = arrowColor;
                ctx.beginPath();
                ctx.moveTo(arrowEndX, arrowEndY);
                ctx.lineTo(headPoint1X, headPoint1Y);
                ctx.lineTo(headPoint2X, headPoint2Y);
                ctx.closePath();
                ctx.fill();

                // Medical imaging software-style label
                const labelText = annotation.description;
                const coordinateText = `(${annotation.x.toFixed(1)}%, ${annotation.y.toFixed(1)}%)`;
                const severityText = severity.toUpperCase();
                
                // Calculate label positioning near arrow start
                let labelX = arrowStartX;
                let labelY = arrowStartY;
                
                // Position label to avoid overlapping with arrow
                if (arrowStartX < displayX) {
                    labelX = arrowStartX - 20;
                } else {
                    labelX = arrowStartX + 20;
                }
                
                // Measure text dimensions for precise label sizing
                ctx.font = 'bold 13px "Segoe UI", "Arial", sans-serif';
                const mainTextWidth = ctx.measureText(labelText).width;
                ctx.font = '10px "Segoe UI", "Arial", sans-serif';
                const coordTextWidth = ctx.measureText(coordinateText).width;
                ctx.font = 'bold 9px "Segoe UI", "Arial", sans-serif';
                const severityTextWidth = ctx.measureText(severityText).width;
                
                const maxTextWidth = Math.max(mainTextWidth, coordTextWidth);
                const labelPadding = 8;
                const labelHeight = 45;
                const labelWidth = maxTextWidth + labelPadding * 2;
                
                // Ensure label stays within canvas bounds
                labelX = Math.max(labelPadding, Math.min(canvas.displayWidth - labelWidth - labelPadding, labelX - labelWidth/2));
                labelY = Math.max(labelHeight/2 + 10, Math.min(canvas.displayHeight - labelHeight/2 - 10, labelY));
                
                // Draw medical imaging style label box
                const cornerRadius = 4;
                
                // Label shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                roundRect(ctx, labelX + 3, labelY - labelHeight/2 + 3, labelWidth, labelHeight, cornerRadius);
                ctx.fill();
                
                // Main label background
                ctx.fillStyle = 'rgba(20, 20, 20, 0.92)';
                roundRect(ctx, labelX, labelY - labelHeight/2, labelWidth, labelHeight, cornerRadius);
                ctx.fill();
                
                // Label border with arrow color
                ctx.strokeStyle = arrowColor;
                ctx.lineWidth = 2;
                roundRect(ctx, labelX, labelY - labelHeight/2, labelWidth, labelHeight, cornerRadius);
                ctx.stroke();
                
                // Main diagnosis text
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 13px "Segoe UI", "Arial", sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(labelText, labelX + labelPadding, labelY - 8);
                
                // Coordinate text
                ctx.fillStyle = '#e0e0e0';
                ctx.font = '10px "Segoe UI", "Arial", sans-serif';
                ctx.fillText(coordinateText, labelX + labelPadding, labelY + 6);
                
                // Severity badge - professional medical style
                const badgeX = labelX + labelWidth - severityTextWidth - 12;
                const badgeY = labelY - labelHeight/2 + 2;
                const badgeWidth = severityTextWidth + 8;
                const badgeHeight = 14;
                
                // Severity badge background
                ctx.fillStyle = severityBadgeColor;
                roundRect(ctx, badgeX, badgeY, badgeWidth, badgeHeight, 2);
                ctx.fill();
                
                // Severity text
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 9px "Segoe UI", "Arial", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(severityText, badgeX + badgeWidth/2, badgeY + 9);
                
                // Reset text alignment
                ctx.textAlign = 'left';
                
                // Add precision indicator to console
                console.log(`Medical Annotation ${index + 1}: "${labelText}" at ultra-precise coordinates (${displayX.toFixed(3)}, ${displayY.toFixed(3)}) - Image: (${annotation.x.toFixed(2)}%, ${annotation.y.toFixed(2)}%) - Severity: ${severityText}`);
            });
        }
        
        // Helper function for rounded rectangles
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // Clear all annotations
        function clearAnnotations() {
            annotations = [];
            if (canvas && ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            document.getElementById('annotationControls').classList.add('hidden');
        }

        // Toggle annotation visibility
        function toggleAnnotations() {
            annotationsVisible = !annotationsVisible;
            drawAnnotations();
        }

        // Add demo annotations for demo mode
        function addDemoAnnotations() {
            annotations = [
                {
                    region: "demo_landmark",
                    x: 25,
                    y: 30,
                    description: "Anatomical landmark reference",
                    severity: "normal"
                },
                {
                    region: "demo_measurement",
                    x: 60,
                    y: 45,
                    description: "Measurement point example",
                    severity: "normal"
                },
                {
                    region: "demo_assessment",
                    x: 40,
                    y: 70,
                    description: "Assessment area demonstration",
                    severity: "normal"
                }
            ];
            document.getElementById('annotationControls').classList.remove('hidden');
            initializeCanvas();
        }

        // Test annotation function with randomized coordinates for demonstration
        function testAnnotations() {
            console.log('Testing high-precision annotations with randomized positions...');
            
            // Generate randomized but realistic coordinates for different findings
            const generateRandomCoord = (min, max) => Math.random() * (max - min) + min;
            
            annotations = [
                {
                    region: "anatomical_region_1",
                    x: parseFloat(generateRandomCoord(15, 35).toFixed(1)),
                    y: parseFloat(generateRandomCoord(15, 35).toFixed(1)),
                    description: "Suspected cortical irregularity",
                    severity: "moderate"
                },
                {
                    region: "anatomical_region_2",
                    x: parseFloat(generateRandomCoord(40, 60).toFixed(1)),
                    y: parseFloat(generateRandomCoord(40, 65).toFixed(1)),
                    description: "Joint space assessment",
                    severity: "mild"
                },
                {
                    region: "anatomical_region_3",
                    x: parseFloat(generateRandomCoord(65, 85).toFixed(1)),
                    y: parseFloat(generateRandomCoord(25, 45).toFixed(1)),
                    description: "Bone density evaluation",
                    severity: "normal"
                },
                {
                    region: "anatomical_region_4",
                    x: parseFloat(generateRandomCoord(30, 50).toFixed(1)),
                    y: parseFloat(generateRandomCoord(60, 80).toFixed(1)),
                    description: "Trabecular pattern analysis",
                    severity: "mild"
                },
                {
                    region: "anatomical_region_5",
                    x: parseFloat(generateRandomCoord(70, 90).toFixed(1)),
                    y: parseFloat(generateRandomCoord(65, 85).toFixed(1)),
                    description: "Soft tissue examination",
                    severity: "normal"
                }
            ];
            
            console.log('Randomized high-precision annotations generated:', annotations.length);
            annotations.forEach((ann, i) => {
                console.log(`${i + 1}. ${ann.description} at (${ann.x}%, ${ann.y}%) - ${ann.severity}`);
            });
            
            document.getElementById('annotationControls').classList.remove('hidden');
            setupCanvas();
        }

        // Enhanced analysis content processing
        function processAnalysisContent(analysisText) {
            // Parse annotations from the text
            parseAnnotations(analysisText);
            
            // Remove annotation markers from displayed text for cleaner reading
            const cleanText = analysisText.replace(/\[ANNOTATION:[^\]]+\]/g, '');
            
            return cleanText;
        }

        function showError(message) {
            // Only show errors in Poe environment, not in demo mode
            if (!isPoeEnvironment) return;
            
            // Create a simple error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    ${message}
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
